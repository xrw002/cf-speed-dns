name: Update DNS IP List

on:
  push:
    paths:
      - 'ipTop10.html'  # ä»…å½“ipTop10.htmlå˜æ›´æ—¶è§¦å‘

jobs:
  process-ips:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç åº“
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²ç”¨äºæ£€æµ‹å˜æ›´

      # æ­¥éª¤2ï¼šæå–IPå¹¶æ ¼å¼åŒ–
      - name: Extract IP Addresses
        run: |
          # ä½¿ç”¨æ­£åˆ™æå–ä¸¥æ ¼ç¬¦åˆè§„èŒƒçš„IPv4åœ°å€ï¼ˆæ’é™¤éæ³•å€¼ï¼‰
          grep -Po '(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}' ipTop10.html | sort -u > cfip.txt

      # æ­¥éª¤3ï¼šè‡ªåŠ¨æäº¤å˜æ›´
      - name: Commit IP Changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions-bot@users.noreply.github.com"
          
          # é…ç½®å«tokençš„è¿œç¨‹åœ°å€ï¼ˆå†™å…¥æƒé™å…³é”®ï¼‰
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

          # æ£€æµ‹æ–‡ä»¶å˜æ›´å¹¶æäº¤
          git add cfip.txt
          if ! git diff --cached --quiet; then
            git commit -m "Auto-update cfip.txt with latest IPs"
            git push
            echo "âœ… IPåˆ—è¡¨å·²æ›´æ–°"
          else
            echo "ğŸ”„ æ— IPå˜æ›´éœ€è¦æäº¤"
          fi
